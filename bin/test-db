#!/bin/bash

#
# Run database tests.
#

set -e

psql='psql -q -d T.001/ia00 --set=ON_ERROR_STOP=1'

dropdb --if-exists T.001/ia00
createdb T.001/ia00
$psql -f config/schema.sql
$psql -f test/fixtures/base.sql

for test in test/db/*.sql; do
    echo -n "$(basename $test .sql) " &&
    $psql -f <(cat <(echo -n 'BEGIN; DO $$ DECLARE result RECORD; BEGIN ') $test <(echo 'END $$; ROLLBACK;')) &&
    echo OK ||
    echo FAILED
done
